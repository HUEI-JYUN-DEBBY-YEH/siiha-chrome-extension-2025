<!doctype html>
<meta charset="utf-8" />
<title>SIIHA ¬∑ Options (Dev)</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", sans-serif; margin: 24px; }
  .card { max-width: 720px; padding: 20px; border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.08); }
  label { display:block; margin:12px 0 6px; font-weight:600; }
  input[type="number"] { width: 120px; padding:6px 8px; }
  .row { display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
  .hint { font-size:12px; opacity:.7; }
  .btn { padding:8px 12px; border-radius:10px; border:1px solid #ddd; background:#fafafa; cursor:pointer; }
  .btn.primary { background:#111; color:#fff; border:none; }
  .radios { display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
</style>

<div class="hint" id="lastNudgeHint" style="margin-top:10px;"></div>

<div class="card">
  <h2 style="margin:0 0 8px">SIIHA ¬∑ Options</h2>
  <div class="hint">Local-only by default. No data leaves your device. Hybrid is OFF.</div>

  <!-- üÜï Rest mode (Off | Periodic) -->
  <label>Rest mode</label>
  <div class="radios" role="radiogroup" aria-label="Rest mode">
    <label style="font-weight:normal">
      <input type="radio" name="restMode" id="restModeOff" value="off">
      Off
    </label>
    <label style="font-weight:normal">
      <input type="radio" name="restMode" id="restModePeriodic" value="periodic">
      Periodic
    </label>
    <span class="hint">Turn reminders off completely, or run on a fixed interval.</span>
  </div>

  <label>Rest reminder interval (minutes)</label>
  <div class="row">
    <input id="remindMinutes" type="number" min="1" step="1" />
    <span class="hint">For testing, use 1‚Äì2. For daily use, 45‚Äì60.</span>
  </div>

  <label>Snooze duration (minutes)</label>
  <div class="row">
    <input id="snoozeMinutes" type="number" min="1" step="1" />
  </div>

  <!-- üÜï Restart behavior (immediate | fixed) -->
  <label>Restart behavior</label>
  <div class="radios" role="radiogroup" aria-label="Restart behavior">
    <label style="font-weight:normal">
      <input type="radio" name="restartMode" id="restartImmediate" value="immediate">
      From now
    </label>
    <label style="font-weight:normal">
     <input type="radio" name="restartMode" id="restartFixed" value="fixed">
      Keep schedule
    </label>
    <span class="hint">When you tap ‚ÄúI‚Äôll rest now,‚Äù either restart from now or keep the schedule.</span>
  </div>

  <label>Mute today</label>
  <div class="row">
    <input id="muteToday" type="checkbox" />
    <span class="hint">Mute nudges for the rest of today.</span>
  </div>

  <label>Hybrid (Firebase AI Logic)</label>
  <div class="row">
    <input id="hybridEnabled" type="checkbox" />
    <span class="hint">Optional. Not enabled in v0.1.</span>
  </div>

  <!-- üÜï Cloud consentÔºàÁïô‰ΩçÔºå‰∏çËß∏ÁôºÂØ¶ÈöõÈõ≤Á´ØÔºâ -->
  <label>Allow cloud generation (Firebase AI)</label>
  <div class="row">
    <input id="cloudConsent" type="checkbox" />
    <span class="hint">Future path. If checked, we‚Äôll remember your consent.</span>
  </div>

  <!-- üÜï PrefÔºöÊòØÂê¶ÂÑ≤Â≠ò‰ªäÊó•ËÅäÂ§© HTML È†êË¶ΩÔºàÈ†êË®≠ÈóúÈñâ‰ª•ÈÅøÂÖçËêΩÂú∞ÂÖ®ÊñáÔºâ -->
  <label>Store today‚Äôs chat preview (HTML)</label>
  <div class="row">
    <input id="persistChatHtmlToday" type="checkbox" />
    <span class="hint">If checked, today‚Äôs chat preview is cached locally for today only.</span>
  </div>

  <!-- üßò Grounding -->
  <hr style="margin:18px 0;border:none;border-top:1px solid #eee">
  <h3 style="margin:0 0 6px">Grounding</h3>
  <div class="row" style="margin:8px 0">
    <input id="groundingRememberPref" type="checkbox" />
    <label for="groundingRememberPref" style="font-weight:normal;margin:0">
      Remember my preferred duration
    </label>
  </div>
  <label for="groundingCooldownMinutes">Cooldown (minutes)</label>
  <div class="row">
    <input id="groundingCooldownMinutes" type="number" min="1" step="1" />
  </div>
  <div class="hint" style="margin-top:6px;line-height:1.4">
    Cooldown keeps grounding from appearing too often.
    If ‚ÄúRemember‚Äù is on, your preferred duration is saved when you finish.
  </div>
  
  <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap">
    <button class="btn primary" id="save">Save</button>
    <button class="btn" id="clear">Clear local data</button>
    <a class="btn" href="privacy.html" target="_blank" rel="noopener">Privacy</a>
    <span id="msg" class="hint" style="align-self:center"></span>
  </div>
</div>

<!-- üÜï Download/Update Local Language Model (Beta) -->
<div class="card" id="modelManagerCard" style="margin-top:24px">
  <h2 style="margin:0 0 8px">Download/Update Local Language Model (Beta)</h2>
  <div class="hint" style="margin-bottom:8px">
    This stays on your device. We‚Äôll check space before downloading.
  </div>
  <!-- üÜï Prompt API availability (real status from LanguageModel.availability) -->
  <div id="pa-section" style="margin:10px 0 12px; line-height:1.6">
    <div><strong>Prompt API status:</strong> <span id="pa-status">unknown</span></div>
    <div class="hint" id="pa-hint">Click ‚ÄúCheck Prompt API‚Äù to detect availability.</div>
    <div class="row" style="gap:8px; margin-top:8px">
      <button class="btn" id="pa-check" title="Query LanguageModel.availability()">Check Prompt API</button>
      <button class="btn primary" id="pa-download" title="Create session to start download">Download / Update</button>
    </div>
  </div>

  <div id="mm-estimate" style="line-height:1.6">
    <div>Storage estimate: <strong id="mm-quota">‚Äî</strong> total ¬∑ <strong id="mm-free">‚Äî</strong> free</div>
    <div>Required: <strong id="mm-required">‚Äî</strong></div>
    <div id="mm-hint" class="hint"></div>
  </div>
  <div id="mm-prog" style="margin-top:10px">
    <progress id="mm-progress" max="100" value="0" style="width:100%"></progress>
    <div id="mm-progress-text" class="hint" style="margin-top:6px;font-family:ui-monospace, SFMono-Regular, Menlo, monospace">0%</div>
  </div>
  <div class="row" style="margin-top:10px;gap:8px;">
    <button class="btn" id="mm-check" title="Re-check available storage">Re-check space</button>
    <button class="btn" id="mm-cancel" title="Cancel current download">Cancel</button>
  </div>
</div>

<!-- Weekly TrendÔºöÂñÆ‰∏ÄÂç°ÁâáÔºåÂÖßÂê´ emotional + crisis ÂÖ©ÊÆµ -->
<div class="card" style="margin-top:24px">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
    <h2 style="margin:0">Weekly Trend</h2>
    <button id="exportAll" class="btn">Export JSON</button>
  </div>
  <div id="weeklyPanel">Loading...</div>
</div>

<!-- Low-mood (3-day threshold) ¬∑ ÂèØË¶ñÂåñ + Ê∏¨Ë©¶Â∑•ÂÖ∑ -->
<div class="card" style="margin-top:24px">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
    <h2 style="margin:0">Low-mood (3-day threshold)</h2>
    <div class="row" style="gap:8px">
      <button class="btn" id="lowMoodRefresh"   title="Refresh panel">Refresh</button>
    </div>
  </div>
  <div id="lowMoodPanel">Loading low-mood status‚Ä¶</div>
</div>

<style>
  canvas { transition: all 0.3s ease; }
</style>

<script type="module" src="options.js"></script>